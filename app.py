# D√©pendances n√©cessaires (pour requirements.txt) :
# streamlit
# pandas
# folium
# streamlit-folium
# (et json, inclus dans la stdlib)

import streamlit as st
import pandas as pd
import json
import os
from datetime import datetime, date
import folium
from streamlit_folium import st_folium

DATA_FILE = "data.json"

# --- Fonctions utilitaires pour la persistance ---
def load_data():
    if not os.path.exists(DATA_FILE):
        data = {
            "departure_date": None,
            "itinerary": [],
            "budget": [],
            "checklist": {
                "passeport_valide": False,
                "billet_avion": False,
                "jr_pass": False,
                "permis_conduire": False,
                "adaptateur": False,
                "vetements": False,
                "trousse_secours": False,
                "banque": False,
                "assurance": False
            }
        }
        with open(DATA_FILE, "w") as f:
            json.dump(data, f)
    else:
        with open(DATA_FILE, "r") as f:
            data = json.load(f)
    return data

def save_data(data):
    with open(DATA_FILE, "w") as f:
        json.dump(data, f, indent=2, ensure_ascii=False)

# --- Initialisation de session_state ---
if "initialized" not in st.session_state:
    st.session_state.data = load_data()
    st.session_state.initialized = True

def sync_state():
    save_data(st.session_state.data)

# --- Protection par mot de passe ---
def check_password():
    def password_entered():
        if st.session_state["password"] == st.secrets["PASSWORD"]:
            st.session_state["password_correct"] = True
            del st.session_state["password"]  # Efface le mot de passe de la session
        else:
            st.session_state["password_correct"] = False

    if "password_correct" not in st.session_state:
        st.text_input(
            "Mot de passe", type="password", on_change=password_entered, key="password"
        )
        if "password_correct" in st.session_state and not st.session_state["password_correct"]:
            st.error("Mot de passe incorrect")
        st.stop()
    elif not st.session_state["password_correct"]:
        st.text_input(
            "Mot de passe", type="password", on_change=password_entered, key="password"
        )
        st.error("Mot de passe incorrect")
        st.stop()

check_password()

# --- Fonctions d'affichage des sections ---
def display_home():
    st.title("Tableau de Bord pour votre voyage au Japon üáØüáµ")
    data = st.session_state.data
    # Date de d√©part
    dep_date = data.get("departure_date")
    if dep_date:
        dep_date_obj = datetime.strptime(dep_date, "%Y-%m-%d").date()
        days_left = (dep_date_obj - date.today()).days
        st.metric("Jours restants avant le d√©part", f"{days_left} jours" if days_left >= 0 else "D√©part pass√©")
    else:
        st.info("Veuillez renseigner la date de d√©part dans l'itin√©raire.")
    # Budget
    total = sum([b["amount"] for b in data.get("budget", [])])
    st.metric("Budget total d√©pens√©", f"{total:.2f} ‚Ç¨")
    # Prochaine t√¢che
    checklist = data.get("checklist", {})
    checklist_labels = [
        ("passeport_valide", "Passeport valide"),
        ("billet_avion", "Billet d'avion imprim√©/PDF"),
        ("jr_pass", "R√©servation JR Pass"),
        ("permis_conduire", "Permis de conduire international"),
        ("adaptateur", "Adaptateur secteur Type A/B"),
        ("vetements", "V√™tements adapt√©s √† la saison"),
        ("trousse_secours", "Trousse de premiers secours"),
        ("banque", "Pr√©venir sa banque"),
        ("assurance", "Souscrire √† une assurance voyage")
    ]
    next_task = next((label for key, label in checklist_labels if not checklist.get(key)), None)
    if next_task:
        st.warning(f"Prochaine t√¢che √† faire : {next_task}")
    else:
        st.success("Toutes les t√¢ches de la checklist sont compl√©t√©es !")

def display_itinerary():
    st.header("üó∫Ô∏è Gestion de l'itin√©raire")
    data = st.session_state.data
    with st.form("add_step"):
        col1, col2 = st.columns(2)
        with col1:
            date_step = st.date_input("Date", value=date(2026, 4, 18))
        with col2:
            city = st.text_input("Ville / Lieu")
        activities = st.text_area("Activit√©s pr√©vues")
        lodging = st.text_input("H√©bergement (nom/lien)")
        submitted = st.form_submit_button("Ajouter l'√©tape")
        if submitted and city:
            data["itinerary"].append({
                "date": str(date_step),
                "city": city,
                "activities": activities,
                "lodging": lodging
            })
            # Si la date de d√©part n'est pas d√©finie, la d√©finir au premier ajout
            if not data["departure_date"]:
                data["departure_date"] = str(date_step)
            sync_state()
            st.success("√âtape ajout√©e !")
            st.experimental_rerun()
    # Affichage de l'itin√©raire
    if data["itinerary"]:
        st.subheader("Votre itin√©raire")
        df = pd.DataFrame(data["itinerary"])
        df = df.sort_values("date")
        for idx, row in df.iterrows():
            with st.expander(f"{row['date']} - {row['city']}"):
                st.markdown(f"**Activit√©s :** {row['activities']}")
                st.markdown(f"**H√©bergement :** {row['lodging']}")
                if st.button(f"Supprimer cette √©tape", key=f"del_{idx}"):
                    data["itinerary"].pop(idx)
                    sync_state()
                    st.experimental_rerun()
    else:
        st.info("Aucune √©tape d'itin√©raire pour l'instant.")

def display_budget():
    st.header("üí¥ Suivi de Budget")
    data = st.session_state.data
    with st.form("add_expense"):
        col1, col2 = st.columns(2)
        with col1:
            description = st.text_input("Description")
            category = st.selectbox("Cat√©gorie", ["Transport", "H√©bergement", "Nourriture", "Activit√©s", "Shopping", "Autres"])
        with col2:
            amount = st.number_input("Montant (en ‚Ç¨)", min_value=0.0, step=0.5)
        submitted = st.form_submit_button("Ajouter la d√©pense")
        if submitted and description and amount > 0:
            data["budget"].append({
                "description": description,
                "amount": float(amount),
                "category": category
            })
            sync_state()
            st.success("D√©pense ajout√©e !")
            st.experimental_rerun()
    # Affichage des d√©penses
    if data["budget"]:
        st.subheader("D√©penses enregistr√©es")
        df = pd.DataFrame(data["budget"])
        st.dataframe(df)
        total = df["amount"].sum()
        st.markdown(f"**Total : {total:.2f} ‚Ç¨**")
        # D√©penses par cat√©gorie
        cat_sum = df.groupby("category")["amount"].sum()
        st.bar_chart(cat_sum)
    else:
        st.info("Aucune d√©pense enregistr√©e.")

def display_checklist():
    st.header("‚úÖ Checklist de Pr√©paration")
    data = st.session_state.data
    checklist = data["checklist"]
    st.subheader("Documents")
    checklist["passeport_valide"] = st.checkbox("Passeport valide", value=checklist["passeport_valide"])
    checklist["billet_avion"] = st.checkbox("Billet d'avion imprim√©/PDF", value=checklist["billet_avion"])
    checklist["jr_pass"] = st.checkbox("R√©servation JR Pass", value=checklist["jr_pass"])
    checklist["permis_conduire"] = st.checkbox("Permis de conduire international", value=checklist["permis_conduire"])
    st.subheader("Bagages")
    checklist["adaptateur"] = st.checkbox("Adaptateur secteur Type A/B", value=checklist["adaptateur"])
    checklist["vetements"] = st.checkbox("V√™tements adapt√©s √† la saison", value=checklist["vetements"])
    checklist["trousse_secours"] = st.checkbox("Trousse de premiers secours", value=checklist["trousse_secours"])
    st.subheader("Administratif")
    checklist["banque"] = st.checkbox("Pr√©venir sa banque", value=checklist["banque"])
    checklist["assurance"] = st.checkbox("Souscrire √† une assurance voyage", value=checklist["assurance"])
    if st.button("Sauvegarder la checklist"):
        sync_state()
        st.success("Checklist sauvegard√©e !")

def get_city_coords(city):
    # Dictionnaire minimal, √† √©tendre selon les besoins
    coords = {
        "Tokyo": (35.6895, 139.6917),
        "Kyoto": (35.0116, 135.7681),
        "Osaka": (34.6937, 135.5023),
        "Hiroshima": (34.3853, 132.4553),
        "Nara": (34.6851, 135.8048),
        "Sapporo": (43.0621, 141.3544),
        "Fukuoka": (33.5902, 130.4017),
        "Nagoya": (35.1815, 136.9066),
        "Kobe": (34.6901, 135.1955),
        "Yokohama": (35.4437, 139.6380)
    }
    return coords.get(city, (None, None))

def display_map():
    st.header("üóæ Carte Interactive de l'itin√©raire")
    data = st.session_state.data
    itinerary = data.get("itinerary", [])
    if not itinerary:
        st.info("Ajoutez des √©tapes √† l'itin√©raire pour voir la carte.")
        return
    # R√©cup√©rer les villes uniques
    cities = {}
    for step in itinerary:
        city = step["city"]
        if city not in cities:
            lat, lon = get_city_coords(city)
            if lat and lon:
                cities[city] = {"lat": lat, "lon": lon, "steps": []}
        if city in cities:
            cities[city]["steps"].append(step)
    if not cities:
        st.warning("Aucune coordonn√©e trouv√©e pour les villes de l'itin√©raire.")
        return
    # Centrer la carte sur la premi√®re ville
    first_city = next(iter(cities.values()))
    m = folium.Map(location=[first_city["lat"], first_city["lon"]], zoom_start=5)
    for city, info in cities.items():
        popup = ""
        for step in info["steps"]:
            popup += f"<b>{step['date']}</b> : {step['activities']}<br>"
        folium.Marker(
            [info["lat"], info["lon"]],
            popup=folium.Popup(popup, max_width=300),
            tooltip=city
        ).add_to(m)
    st_folium(m, width=700, height=500)

def display_resources():
    st.header("üîó Ressources Utiles")
    st.subheader("Convertisseur EUR ‚Üí JPY")
    taux = 165  # Taux fixe, √† ajuster ou automatiser
    eur = st.number_input("Montant en EUR", min_value=0.0, step=1.0, key="eur_input")
    jpy = eur * taux
    st.write(f"‚âà {jpy:.0f} ¬• (taux : 1‚Ç¨ = {taux}¬•)")
    st.subheader("Phrases utiles üáØüáµ")
    st.markdown("""
- Bonjour : „Åì„Çì„Å´„Å°„ÅØ (Konnichiwa)
- Merci : „ÅÇ„Çä„Åå„Å®„ÅÜ (Arigatou)
- Excusez-moi : „Åô„Åø„Åæ„Åõ„Çì (Sumimasen)
- Oui : „ÅØ„ÅÑ (Hai)
- Non : „ÅÑ„ÅÑ„Åà (Iie)
- O√π sont les toilettes ? : „Éà„Ç§„É¨„ÅØ„Å©„Åì„Åß„Åô„ÅãÔºü (Toire wa doko desu ka?)
    """)
    st.subheader("Liens importants")
    st.markdown("""
- [Ambassade du Japon en France](https://www.fr.emb-japan.go.jp/)
- [Japan Rail Pass](https://www.japan-rail-pass.fr/)
- [Hyperdia (trains)](https://www.hyperdia.com/)
- [JR East](https://www.jreast.co.jp/e/)
    """)

# --- Navigation principale ---
menu = [
    "Accueil",
    "Itin√©raire",
    "Budget",
    "Checklist",
    "Carte",
    "Ressources"
]
choix = st.sidebar.radio("Navigation", menu, format_func=lambda x: x)

if choix == "Accueil":
    display_home()
elif choix == "Itin√©raire":
    display_itinerary()
elif choix == "Budget":
    display_budget()
elif choix == "Checklist":
    display_checklist()
elif choix == "Carte":
    display_map()
elif choix == "Ressources":
    display_resources()

st.sidebar.markdown("---")
st.sidebar.info("üáØüáµ Application de pr√©paration de voyage au Japon ‚Äî par votre assistant IA") 